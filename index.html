// ==== SUPABASE ====
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

// Supabase ma'lumotlaringiz:
const SUPABASE_URL = 'https://kkgqjomcitybtwofcosl.supabase.co'
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZ3Fqb21jaXR5YnR3b2Zjb3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTUwNjUsImV4cCI6MjA3NzU5MTA2NX0.utPwP0hD8TwgSf_CJu9oFl2N5hIeG_meOgDwHFEQSTs'
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

// ==== Rasm yuklash funksiyasi ====
async function uploadImage(base64data, filename, isRawBase64 = true) {
  try {
    result.textContent = "Yuklanmoqda... Iltimos kuting."

    // Base64 → Blob aylantiramiz
    const byteCharacters = atob(base64data)
    const byteNumbers = new Array(byteCharacters.length)
    for (let i = 0; i < byteCharacters.length; i++) {
      byteNumbers[i] = byteCharacters.charCodeAt(i)
    }
    const byteArray = new Uint8Array(byteNumbers)
    const blob = new Blob([byteArray], { type: 'image/jpeg' })

    // Supabase Storage'ga yuklash
    const { data, error } = await supabase.storage
      .from('images')        // bucket nomi
      .upload(filename, blob, { upsert: true }) // mavjud bo'lsa yangilaydi

    if (error) throw error

    // Public URL olish
    const { data: publicData } = supabase.storage
      .from('images')
      .getPublicUrl(filename)

    result.innerHTML = `✅ Yuklandi!<br><a href="${publicData.publicUrl}" target="_blank" style="color:#a7f3d0">Rasmni ko‘rish</a>`
  } catch (err) {
    console.error(err)
    result.textContent = "❌ Yuklashda xato: " + err.message
  }
}
