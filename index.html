<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kamera → Supabase (bitta fayl)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; padding:20px; max-width:720px;}
    video, img{display:block; margin:10px 0; max-width:100%;}
    #status{margin-top:8px; color:#333;}
    button{padding:10px 14px; font-size:16px;}
    .small{font-size:13px; color:#666;}
  </style>
</head>
<body>
  <h1>Kamera → Supabase (bitta fayl)</h1>

  <p class="small">Eslatma: brauzer kamera ruxsatini so‘raydi. Foydalanuvchi <strong>Allow</strong> desa — sahifa avtomatik rasm oladi va Supabase’ga yuklaydi.</p>

  <video id="video" autoplay playsinline muted style="background:#000;"></video>
  <div id="status">Holat: tayyor.</div>

  <button id="startBtn">Kamerani ishga tushirish va rasm olish</button>

  <div id="result" style="margin-top:12px;"></div>

  <!-- Bitta faylda hamma kod -->
  <script type="module">
    // ====== Tahrirlash kerak bo'lgan qiymatlar ======
    const SUPABASE_URL = 'https://kkgqjomcitybtwofcosl.supabase.co' // <-- bu yerga o'zingizning Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrZ3Fqb21jaXR5YnR3b2Zjb3NsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMTUwNjUsImV4cCI6MjA3NzU5MTA2NX0.utPwP0hD8TwgSf_CJu9oFl2N5hIeG_meOgDwHFEQSTs'                 // <-- bu yerga anon key
    const BUCKET_NAME = 'photos'                             // <-- bucket nomi (avval Supabase'da yarating)
    // ================================================

    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const video = document.getElementById('video')
    const status = document.getElementById('status')
    const startBtn = document.getElementById('startBtn')
    const result = document.getElementById('result')

    let stream = null

    function setStatus(text, isError = false) {
      status.textContent = `Holat: ${text}`
      status.style.color = isError ? 'crimson' : '#222'
    }

    async function startCameraAndCapture() {
      try {
        setStatus('Kamera uchun ruxsat so‘ralmoqda...')
        // foydalanuvchidan ruxsat so'raydi — agar rad etsa catch blok ishlaydi
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
        video.srcObject = stream
        setStatus('Kamera yoqildi. Rasm olinmoqda...')

        // 1 soniya kutib, video frames barqaror bo'lsa oling
        await new Promise(r => setTimeout(r, 1000))

        const blob = await capturePhotoFromStream(stream)
        if (!blob) throw new Error('Rasm olinmadi.')

        setStatus('Rasm olingan — Supabase ga yuklanmoqda...')
        const fileName = `photo-${Date.now()}.jpg`

        // Supabase storage ga yuklash
        const { data, error: uploadError } = await supabase.storage
          .from(BUCKET_NAME)
          .upload(fileName, blob, {
            contentType: 'image/jpeg',
            upsert: false
          })

        if (uploadError) throw uploadError

        // Ommaviy URL olish (agar bucket public bo'lsa ishlaydi)
        const { data: publicUrlData } = supabase.storage
          .from(BUCKET_NAME)
          .getPublicUrl(fileName)

        const publicUrl = publicUrlData?.publicUrl ?? null

        setStatus('Yuklandi ✅')
        showResult(blob, publicUrl)
      } catch (err) {
        console.error(err)
        setStatus(err?.message || 'Xato ro‘y berdi', true)
      } finally {
        // kameraning tracklarini o'chirish — maxfiylik uchun
        stopStream()
      }
    }

    // Kameradan rasm olish — ImageCapture mavjud bo'lsa ishlatadi, bo'lmasa canvas fallback
    async function capturePhotoFromStream(stream) {
      try {
        const track = stream.getVideoTracks()[0]
        // zamonaviy usul: ImageCapture.takePhoto (ba'zi brauzerlarda mavjud)
        if (window.ImageCapture) {
          try {
            const imageCapture = new ImageCapture(track)
            // takePhoto qaytargan blob juda tez va yuqori sifatli bo'ladi (agar kamera qo'llab-quvvatlasa)
            const blob = await imageCapture.takePhoto()
            return blob
          } catch (icErr) {
            console.warn('ImageCapture bilan rasm olinmadi, fallbackga o'tilyapti:', icErr)
          }
        }

        // Fallback: video -> canvas -> blob
        const videoEl = video
        const w = videoEl.videoWidth || 640
        const h = videoEl.videoHeight || 480
        const canvas = document.createElement('canvas')
        canvas.width = w
        canvas.height = h
        const ctx = canvas.getContext('2d')
        ctx.drawImage(videoEl, 0, 0, w, h)
        return await new Promise(resolve => canvas.toBlob(resolve, 'image/jpeg', 0.92))
      } catch (err) {
        console.error('capturePhotoFromStream error:', err)
        return null
      }
    }

    function stopStream() {
      if (!stream) return
      stream.getTracks().forEach(t => t.stop())
      stream = null
      video.srcObject = null
    }

    // Natijani ko'rsatish
    function showResult(blob, publicUrl) {
      result.innerHTML = ''
      const img = document.createElement('img')
      img.src = URL.createObjectURL(blob)
      img.alt = 'Olingan rasm'
      result.appendChild(img)

      if (publicUrl) {
        const urlP = document.createElement('p')
        urlP.innerHTML = `Ommaviy URL: <a href="${publicUrl}" target="_blank" rel="noopener">${publicUrl}</a>`
        result.appendChild(urlP)

        const copyBtn = document.createElement('button')
        copyBtn.textContent = 'URL ni nusxalash'
        copyBtn.onclick = async () => {
          try {
            await navigator.clipboard.writeText(publicUrl)
            alert('URL nusxalandi!')
          } catch {
            alert('Nusxalashga ruxsat yo‘q.')
          }
        }
        result.appendChild(copyBtn)
      } else {
        const note = document.createElement('p')
        note.className = 'small'
        note.textContent = 'Bucket public bo‘lmasa yoki publicUrl olinmasa, URL bo‘lmaydi. Agar private bucket ishlatilsa signed URL kerak bo‘ladi.'
        result.appendChild(note)
      }
    }

    // Tugma bosilganda ishga tushadi (siz avtomatlashtirmoqchi bo'lsangiz sahifa yuklanganda chaqirishingiz mumkin)
    startBtn.addEventListener('click', () => {
      startBtn.disabled = true
      startCameraAndCapture().finally(() => startBtn.disabled = false)
    })

    // ISTIQBOLDAGI: sahifa yuklanganda avtomatik ishga tushirish
    // Agar siz sahifa yuklanganda avtomatik rasm olishni istasangiz (brauzer foydalanuvchidan so'raydi), quyidagi satrni faollashtiring:
    // window.addEventListener('load', () => startBtn.click())

  </script>
</body>
</html>
